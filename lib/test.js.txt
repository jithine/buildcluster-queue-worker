
'use strict';

const config = require('config');
const ExecutorRouter = require('screwdriver-executor-router');
const executorConfig = config.get('executor');
const ecosystem = config.get('ecosystem');

function getWeightedExecutor(executors) {
    const totalWeight = executors.reduce((prev, curr) => prev + curr.weightage, 0);

    if (totalWeight === 0) {
        return undefined;
    }
    const number = Math.floor(Math.random() * totalWeight);

    let sum = 0;

    for (let i = 0; i < executors.length; i++) {
        sum += executors[i].weightage;

        if (number < sum) return executors[i].name;
    }

    return executors[0].name;
}

function test() {
    const executorPlugins = Object.keys(executorConfig).reduce((aggregator, keyName) => {
        if (keyName !== 'plugin') {
            aggregator.push(Object.assign({
                name: keyName
            }, executorConfig[keyName]));
        }

        return aggregator;
    }, []);

    console.log(executorPlugins);

    const selectedExecutor = getWeightedExecutor(executorPlugins);

    console.log(selectedExecutor);
    const r = executorPlugins.find(e => e.name === selectedExecutor);

    console.log(r);
    const executor = new ExecutorRouter({
        defaultPlugin: executorConfig.plugin,
        executor: selectedExecutor ? [].concat(r) : executorPlugins,
        ecosystem
    });

    console.log(executor);
}

test();

